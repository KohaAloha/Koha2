[% USE Koha %]
[% INCLUDE 'doc-head-open.inc' %]
<title>Koha &rsaquo; Patron search</title>
[% INCLUDE 'doc-head-close.inc' %]
<link rel="stylesheet" type="text/css" href="[% themelang %]/css/datatables.css" />
[% INCLUDE 'datatables.inc' %]

<script type="text/javascript">
//<![CDATA[

$(document).ready(function(){
    $("#info").hide();
    $("#error").hide();
    // Apply DataTables on the results table
    dtMemberResults = $("#memberresultst").dataTable($.extend(true, {}, dataTablesDefaults, {
        'bServerSide': true,
        'sAjaxSource': "/cgi-bin/koha/svc/members/search",
        'fnServerData': function(sSource, aoData, fnCallback) {
            aoData.push({
                'name': 'template_path',
                'value': 'acqui/tables/members_results.tt',
            }
            [% IF patrons_with_acq_perm_only %]
            ,{
                'name': 'has_permission',
                'value': 'acquisition.order_manage',
            }
            [% END %]
            );
            $.ajax({
                'dataType': 'json',
                'type': 'POST',
                'url': sSource,
                'data': aoData,
                'success': function(json){
                    fnCallback(json);
                }
            });
        },
        'aoColumns':[
            { 'mDataProp': 'dt_cardnumber' },
            { 'mDataProp': 'dt_name' },
            { 'mDataProp': 'dt_branch' },
            { 'mDataProp': 'dt_category' },
            { 'mDataProp': 'dt_action', 'bSortable': false }
        ],
        'bAutoWidth': false,
        [% IF patrons_with_acq_perm_only %]
            'bPaginate': false,
        [% ELSE %]
            'sPaginationType': 'full_numbers',
            "iDisplayLength": [% Koha.Preference('PatronsPerPage') %],
            "bProcessing": true,
        [% END %]
        'bProcessing': true,
    }));
    dtMemberResults.fnAddFilters("filter", 750);
});

    // modify parent window owner element
    function add_user(borrowernumber, borrowername) {
        var p = window.opener;
        $("#info").hide();
        $("#error").hide();
        if ( p.add_user(borrowernumber, borrowername) < 0 ) {
            $("#error").html(_("Borrower '%s' is already in the list.").format(borrowername));
            $("#error").show();
        } else {
            $("#info").html(_("Borrower '%s' added.").format(borrowername));
            $("#info").show();

        }
    }
//]]>
</script>

</head>
<body>
<div id="patron_search" class="yui-t7">
  <div id="bd">
    <div class="yui-g">

        <h3>Search for patron</h3>
        [% IF patrons_with_acq_perm_only %]
            <div class="hint">Only staff with superlibrarian or acquisitions permissions (or order_manage permission if granular permissions are enabled) are returned in the search results</div>
        [% END %]

        <div id="info" class="dialog message"></div>
        <div id="error" class="dialog alert"></div>

        <table id="memberresultst">
          <thead>
            <tr>
              <th>Card</th>
              <th>Name</th>
              <th>Library</th>
              <th>Category</th>
              <th>&nbsp;</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

<div id="closewindow"><a href="#" class="close">Close</a></div>
</div>
</div>
[% INCLUDE 'intranet-bottom.inc' %]
